apply plugin: 'com.android.application'
apply plugin: 'kotlin-android'
apply plugin: 'kotlin-android-extensions'
apply plugin: 'kotlin-kapt'
apply from: 'and_res_guard.gradle'
apply plugin: 'bugly'

def buglyAppId = 'c6e450ad19'
def buglyAppKey = '54ece6d9-fcb0-4ce2-8dae-b86efb65617c'
def buglyAppIdDebug = 'c6e450ad19'
def buglyAppKeyDebug = '54ece6d9-fcb0-4ce2-8dae-b86efb65617c'
def buglyAppIdRelease = 'c6e450ad19'
def buglyAppKeyRelease = '54ece6d9-fcb0-4ce2-8dae-b86efb65617c'

android {
  compileSdkVersion 29
  defaultConfig {
    applicationId rootProject.ext.android.applicationId
    minSdkVersion 23
    targetSdkVersion 29
    versionCode rootProject.ext.android.versionCode
    versionName rootProject.ext.android.versionName
    resValue "string", "build_time", rootProject.ext.android.buildTime
    //允许使用SVG
//    vectorDrawables.useSupportLibrary = true
    multiDexEnabled true
    resConfigs "zh", "en" //保留中文和英文资源
    ndk {
      abiFilters 'armeabi-v7a' //, 'arm64-v8a'
    }
    //资源文件名冲突，引用包重复，文件名显示的格式与文件本身的格式不对应
//    aaptOptions.cruncherEnabled = false
//    aaptOptions.useNewCruncher = false
  }
  compileOptions {
    sourceCompatibility JavaVersion.VERSION_1_8
    targetCompatibility JavaVersion.VERSION_1_8
  }
  //flavorDimensions "default"
  ////公开发布商店渠道配置
  //productFlavors {
  //  //程序员本地跑的包(只直接在AS中跑，不打包给其他人)
  //  Developer {
  //    dimension "default"
  //  }
  //  //打包后★必须使用多渠道设置渠道★(不直接跑包，打包时使用)
  //  Package {
  //    dimension "default"
  //  }
  //}

  //配置不同版本的keystore
  signingConfigs {
    debug {
      storeFile file(STORE_FILE_ABASE)
      storePassword STORE_PASSWORD_ABASE
      keyAlias KEY_ALIAS_ABASE
      keyPassword KEY_PASSWORD_ABASE
    }
    release {
      storeFile file(STORE_FILE_ABASE)
      storePassword STORE_PASSWORD_ABASE
      keyAlias KEY_ALIAS_ABASE
      keyPassword KEY_PASSWORD_ABASE
    }
  }
  buildTypes {
    debug {
      zipAlignEnabled false
      shrinkResources false
      minifyEnabled false
      signingConfig signingConfigs.debug
      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
      buglyAppId = buglyAppIdDebug
      buglyAppKey = buglyAppKeyDebug
      resValue "string", "bugly_app_id", buglyAppIdDebug
    }
    release {
      zipAlignEnabled true
      shrinkResources true
      minifyEnabled true
      signingConfig signingConfigs.release
      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
      buglyAppId = buglyAppIdRelease
      buglyAppKey = buglyAppKeyRelease
      resValue "string", "bugly_app_id", buglyAppIdRelease
    }
  }
}

android.applicationVariants.all { variant ->
  variant.outputs.all {
    //名称
    String appName = ""
    String path = getProjectDir().getPath() + "/src/main/res/values/strings.xml"
    new XmlSlurper().parse(path)."string".find { name ->
      if (name."@name" == "app_name") {
        appName = name
        return true
      }
    }
    //正式版还是测试版
    String typeName = buildType.name
    typeName = typeName.substring(0, 1).toUpperCase() + typeName.substring(1).toLowerCase()
    //build名称
    String buildVer = String.valueOf(rootProject.ext.android.versionCode)
    String buildName = "_build" + buildVer
    //编译日期
    String buildTime = "_" + String.valueOf(rootProject.ext.android.buildTime)
    //打包的电脑
    String computer = "_" + String.valueOf(rootProject.ext.android.computer)
    //后缀名
    String suffix = ".apk"
    //生成输出文件名称
    outputFileName = "${appName}${typeName}${buildName}${buildTime}${computer}${suffix}"
  }
}
//强制使用lib版本，解决个版本导致包重复无法混淆的问题 https://www.jianshu.com/p/c602e6c493ce
configurations.all {
  resolutionStrategy {
    force 'androidx.appcompat:appcompat:1.1.0'
    force 'androidx.annotation:annotation:1.1.0'
    force 'androidx.core:core:1.1.0'
    force 'androidx.fragment:fragment:1.1.0'
    force 'androidx.collection:collection:1.1.0'
    force 'androidx.lifecycle:lifecycle-runtime:2.1.0'
    force 'androidx.lifecycle:lifecycle-viewmodel:2.1.0'
    force 'androidx.lifecycle:lifecycle-common:2.1.0'
    force 'androidx.arch.core:core-common:2.1.0'
    force 'androidx.recyclerview:recyclerview:1.0.0-rc01'
    force 'androidx.legacy:legacy-support-core-ui:1.0.0-rc01'
    force 'androidx.legacy:legacy-support-core-utils:1.0.0-rc01'
    force 'androidx.cursoradapter:cursoradapter:1.0.0-rc01'
    force 'androidx.drawerlayout:drawerlayout:1.0.0-rc01'
    force 'androidx.viewpager:viewpager:1.0.0-rc01'
    force 'androidx.loader:loader:1.0.0-rc01'
    force 'androidx.customview:customview:1.0.0-rc01'
    force 'androidx.interpolator:interpolator:1.0.0-rc01'
    force 'androidx.lifecycle:lifecycle-livedata-core:2.0.0-rc01'
    force 'androidx.lifecycle:lifecycle-extensions:2.1.0'
    force 'androidx.arch.core:core-runtime:2.0.0-rc01'

    force 'com.google.guava:guava:27.0.1-jre'
    force 'com.google.code.findbugs:jsr305:3.0.2'
    force 'com.google.android.material:material:1.0.0-rc01'
    force 'com.squareup.okhttp3:okhttp:3.14.0'
    force 'com.google.code.gson:gson:2.8.5'

    force 'io.reactivex.rxjava2:rxjava:2.2.10'

    force "org.jetbrains.kotlin:kotlin-stdlib:1.3.50"
    force "org.jetbrains.kotlin:kotlin-stdlib-jdk7:1.3.50"
    force "org.jetbrains.kotlin:kotlin-stdlib-common:1.3.50"

    force 'com.squareup.okio:okio:1.17.4'
  }
}

bugly {
  debug = true
  appId = buglyAppId
  appKey = buglyAppKey
}

dependencies {
  implementation fileTree(dir: 'libs', include: ['*.jar'])
  implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk7:$kotlin_version"
  implementation project(':ablibrary')

  implementation 'androidx.appcompat:appcompat:1.1.0'
  implementation 'androidx.core:core-ktx:1.1.0'
  implementation 'androidx.constraintlayout:constraintlayout:1.1.3'
  //表情
  implementation 'com.vanniktech:emoji-ios:0.6.0'
  //封面获取，视频压缩
  implementation 'com.github.microshow:RxFFmpeg:2.1.0'

  //必选 https://github.com/dueeeke/DKVideoPlayer/wiki
  implementation 'com.github.dueeeke.dkplayer:dkplayer-java:3.1.4'
  //可选，包含StandardVideoController的实现
  implementation 'com.github.dueeeke.dkplayer:dkplayer-ui:3.1.4'
  //可选，使用exoplayer进行解码（推荐）
  implementation 'com.github.dueeeke.dkplayer:player-exo:3.1.4'

  //弹幕 https://github.com/bilibili/DanmakuFlameMaster
  implementation 'com.github.ctiao:DanmakuFlameMaster:0.9.25'
  implementation 'com.github.ctiao:ndkbitmap-armv7a:0.9.21'

  //图片选择https://github.com/LuckSiege/PictureSelector
  implementation 'com.github.LuckSiege.PictureSelector:picture_library:v2.2.4'

  //bugly https://bugly.qq.com/docs/user-guide/instruction-manual-android/?v=20190916214340
  implementation 'com.tencent.bugly:crashreport:3.1.0'
  implementation 'com.tencent.bugly:nativecrashreport:3.7.1'
  //https://github.com/airbnb/epoxy 放在lib中失败
  kapt 'com.airbnb.android:epoxy-processor:3.8.0'
}